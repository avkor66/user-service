{{> nav }}

<div class="container" style="margin-top: 6rem; width: 40vw">
    <div class="grey lighten-3">
        <h4 class="center-align" style="padding: 0.5rem 0">Edit user profile</h4>
        <div class="card z-depth-0">
            <form action="/profile/update" method="POST" id="edit-form">
                <ul class="collapsible">
                    <li>
                        <div class="collapsible-header">FirstName
                            <span class="badge">{{user.firstName}}</span>
                        </div>
                        <div class="collapsible-body">
                            <input id="first_name" type="text" name="firstName" class="validate">
                            <label for="first_name">To change, enter a new first name value</label>
                        </div>
                    </li>
                    <li>
                        <div class="collapsible-header">LastName
                            <span class="badge">{{user.lastName}}</span>
                        </div>
                        <div class="collapsible-body">
                            <input id="last_name" type="text" name="lastName" class="validate">
                            <label for="last_name">To change, enter a new last name value</label>
                        </div>
                    </li>
                    <li>
                        <div class="collapsible-header">MiddleName
                            <span class="badge">{{user.middleName}}</span>
                        </div>
                        <div class="collapsible-body">
                            <input id="middle_name" type="text" name="middleName" class="validate">
                            <label for="middle_name">To change, enter a new middle name value</label>
                        </div>
                    </li>
                    <li>
                        <div class="collapsible-header">Date of birth
                            <span class="badge">{{user.birthDate}}</span>
                        </div>
                        <div class="collapsible-body">
                            <input id="birthday" type="date" name="birthDate" class="validate">
                            <label for="birthday">To change, enter a new date of birth value</label>
                        </div>
                    </li>
                </ul>
                <ul class="card z-depth-0">
                    <li>
                        <div class="collapsible-header">Email
                            <span class="badge" style="margin-left: 5rem">{{user.email}}</span>
                        </div>

                    </li>
                    <li>
                        <div class="collapsible-header">Role
                            <span class="badge" style="margin-left: 6rem">{{user.role}}</span>
                        </div>
                    </li>
                    <li>
                        <div class="collapsible-header">Active
                            {{#if user.isActive}}
                                <span class="badge green-text" style="margin-left: 5rem">Yes</span>
                            {{else}}
                                <span class="badge red-text" style="margin-left: 5rem">No</span>
                            {{/if}}
                        </div>
                    </li>
                    <li>
                        <div class="collapsible-header">
                            Registration
                            <span class="badge" style="margin-left: 2rem">{{user.createdAt}}</span>
                        </div>
                    </li>
                    <li style="margin-top: 2rem;">
                        <button class="btn waves-effect waves-light" type="submit" id="submit" disabled>Update
                            <i class="material-icons right">update</i>
                        </button>
                        <a class="waves-effect red accent-1 btn modal-trigger" href="#modal1">Delete
                            <i class="material-icons right">delete</i>
                        </a>
                    </li>
                </ul>
                <div class="input-field col s12" style="height: 1rem">
                    <div id="error-message"></div>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Structure -->
<div id="modal1" class="modal">
    <div class="modal-content">
        <h4>Delete user</h4>
        <p>Are you sure you want to delete the user?</p>
    </div>
    <div class="modal-footer">
        <a href="#" class="modal-close waves-effect waves-green btn-flat" id="agree">Agree</a>
        <a href="#" class="modal-close waves-effect waves-red btn-flat">Disagree</a>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const elems = document.querySelectorAll('.collapsible');
        M.Collapsible.init(elems);

        const modal = document.querySelectorAll('.modal');
        M.Modal.init(modal);
    });

    const form = document.getElementById('edit-form');
    const submit = document.getElementById('submit');
    const errMsg = document.getElementById('error-message');
    const isValidName = (val) => /^[A-Za-zА-яа-яЁё]+$/.test(val) && val.trim().length >= 2;
    const isValidDate = (val) => {
        if (!val) return false;
        const date = new Date(val);
        const now = new Date();
        return date.getFullYear() <= now.getFullYear() - 13 && date.getFullYear() >= now.getFullYear() - 100;
    };

    const classListCorrect = (form, isValid) => {
        if (isValid) {
            form.classList.add('validate');
            form.classList.remove('invalid');
        } else {
            form.classList.add('invalid');
            form.classList.remove('validate');
        }
    }

    const errorMessagesTemplate = {
        name: '<span class="message error-message">Invalid name (at least 2 characters)</span>',
        middle: '<span class="message error-message">Incorrect characters in middlename</span>',
        birth: '<span class="message error-message">Invalid date of birth (less than 13 years)</span>'
    }

    const validateForm = (eventForm) => {
        const firstName = form.firstName.value;
        const lastName = form.lastName.value;
        const middleName = form.middleName.value;
        const birthDate = form.birthDate.value;

        let firstNameFlag = false;
        let lastNameFlag = false;
        let middleNameFlag = false;
        let birthDateFlag = false;
        let valid = true;
        errMsg.innerHTML = '';

        switch (eventForm) {
            case "firstName":
                firstNameFlag = true;
                if (!isValidName(firstName)) {
                    valid = false;
                    errMsg.innerHTML = errorMessagesTemplate.name;
                    classListCorrect(form.firstName, false);
                } else classListCorrect(form.firstName, true);
                if (firstName.length === 0) {
                    classListCorrect(form.firstName, true);
                    valid = true;
                    errMsg.innerHTML = '';
                    firstNameFlag = false;
                }
                break;

            case "lastName":
                lastNameFlag = true;
                if (!isValidName(lastName)) {
                    valid = false;
                    errMsg.innerHTML = errorMessagesTemplate.name;
                    classListCorrect(form.lastName, false);
                } else classListCorrect(form.lastName, true);
                if (lastName.length === 0) {
                    classListCorrect(form.lastName, true);
                    valid = true;
                    errMsg.innerHTML = '';
                    lastNameFlag = false;
                }
                break;

            case "middleName":
                middleNameFlag = true;
                if (!/^[A-Za-zА-яа-яЁё]+$/.test(middleName)) {
                    valid = false;
                    errMsg.innerHTML = errorMessagesTemplate.middle;
                    classListCorrect(form.middleName, false);
                } else classListCorrect(form.middleName, true);
                if (middleName.length === 0) {
                    classListCorrect(form.middleName, true);
                    valid = true;
                    errMsg.innerHTML = '';
                    middleNameFlag = false;
                }
                break;

            case "birthDate":
                birthDateFlag = true;
                if (!isValidDate(birthDate)) {
                    valid = false;
                    errMsg.innerHTML = errorMessagesTemplate.birth;
                    classListCorrect(form.birthDate, false);
                } else classListCorrect(form.birthDate, true);
                if (birthDate.length === 0) {
                    classListCorrect(form.birthDate, true);
                    valid = true;
                    errMsg.innerHTML = '';
                    birthDateFlag = false;
                }
                break;
        }

        if (!firstNameFlag && !lastNameFlag && !middleNameFlag && !birthDateFlag) valid = false;

        submit.disabled = !valid;
    };

    form.querySelectorAll('input').forEach(input => {
        input.addEventListener('change', (i) => validateForm(i.target.name));
    });

    form.addEventListener('submit', (e) => {
        if (submit.disabled) e.preventDefault();
    });

    const agree = document.getElementById('agree');
    agree.addEventListener('click', async (e) => {
        try {
            const response = await fetch('/profile', {
                method: 'DELETE',
                headers: { 'Content-Type': 'application/json' },
            });
            if (response.ok) {
                const result = await response.json();

                window.location.href = '/';

            } else {
                const error = await response.json();
                alert(`Error: ${error.message}`);
            }
        } catch (error) {
            console.error('Network error:', error);
            alert('Network error');
        }
    })

</script>